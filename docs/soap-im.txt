IMGetRoster -- get buddy list
-----------
<IMGetRosterRequest/>

<IMGetRosterResponse>
     <presence SEE BELOW/> // MY current presence value
     
     <chats>
        [  // 0 or more active chats
           <chat thread="threadID">
              <pcps> // participants
                 [<p addr="foo@bar.com"/>]* // participants (NOT including yourself) in this chat
              </pcps>
           </chat>
        ]*
     </chats>

     Roster data is sent asynchronously from the server (see "Asynchronous Roster Response" below)
     in the next notification block.

</IMGetRosterResponse>



IMSubscribe -- subscribe to someone's presence / modify subscription 
-----------
<IMSubscribeRequest addr="foo@bar.com" [name="friendly name"] [groups="group,group..."] [op="add|remove"]/>

// If the user specified an alias, the server will resolve the alias
// to a canonical address -- and add the canonical address to the
// Buddy List.  The addr returned might be different than the
// requested addr
<IMSubscribeResponse addr="might-be-different@domain.com"/>


IMAuthorizeSubscribe -- used to OK another user adding you to their buddy list
--------------------    send this in response to a <subscribe> notification
                        Optionally, add this user to my buddy list as well

<IMAuthorizeSubscribeRequest addr="foo@bar.com" authorized="true|false"
                             [add="true|false" name="nickname" groups="group,group..."]/>
<IMAuthorizeSubscribeResponse/>


IMSetPresence -- modify your presence state
-------------
<IMSetPresenceRequest [idle="seconds_idle"]>
   [
     <presence [lang="en"] [show="away|chat|dnd|xa|online|offline"] [priority="0-255"] [status="CUSTOM_STATUS"]/>
   ]+  // if multiple, each must have a different lang  
</IMSetPresenceRequest>

<IMSetPresenceResponse>


IMGetChat -- return the chat history (param = num messages)
---------
<IMGetChatRequest thread="threadID" [seq="1st-sequence-to-retrieve"]/>

// chat unknown (server restart?  server flushed it due to idleness?)
<IMGetChatResponse thread="threadID" error="not_found"/>

// chat known:
<IMGetChatResponse>
   <chat thread="threadID">
      <pcps> // like email-element-cache -- only valid for this single message!
         <p id="num" addr="foo@bar.com" [name="friendly"] [resource="resource"]/>*
      </pcps>
      <messages>
         <message seq="sequence-number" ts="timestamp" from="id">
            [<subject [lang="LANGUAGE"]>SUBJECT</subject>]*   // HTML
            [<body [lang="LANGUAGE">BODY</body>]              // HTML
         </message>
      </messages>   
   </chat>
</IMGetChatResponse>


IMSendMessage -- send a new message, optional chat parameter
-------------
To an existing chat:
<IMSendMessageRequest>
   <message thread="threadID">
      [<subject [lang="LANGUAGE"]>
         SUBJECT_AS_XML
      </subject>]*   // HTML
      [<body [lang="LANGUAGE">
         BODY
      </body>]              // HTML
      [<typing/>]
   </message>
</IMSendMessageRequest>
   
...OR create a new chat:
<IMSendMessageRequest>
   <message addr="foo@bar.com">
      [<subject [lang="LANGUAGE"]>SUBJECT</subject>]*   // HTML
      [<body [lang="LANGUAGE">BODY</body>]              // HTML
      [<typing/>]
   </message>
</IMSendMessageRequest>

<IMSendMessageResponse thread="thread id"/>

**Send a blank message to indicate/stop typing indicator by itself**



   
IMModifyChat -- add/remove users from multi-user chat, adjust save preferences, etc
------------
<IMModifyChatRequest thread="threadId" op="close"/>
<IMModifyChatRequest thread="threadId" op="adduser" addr="address>INVITATION_MESSAGE</IMModifyChatRequest>

// chat unknown (server restart?  server flushed it due to idleness?)
<IMModifyChatResponse thread="threadID" error="not_found"/>

// successful
<IMModifyChatResponse thread="threadId"/>



IMJoinChat -- join a multi-user chat you have been invited to
----------
<IMJoinChatRequest thread="threadId" addr="chatAddr"/>
</IMJoinChatResponse>
// **look for notification: <n type="enteredchat" thread="threadId"/>**



IMGetPrivacyList -- request the privacy list
-----------------
<IMGetPrivacyListRequest [name="list_name"]/> // gets default list if
                                              // no name specified
   // response in 'privacy' notification below
<IMGetPrivacyListResponse/>


IMSetPrivacyList -- sets the list
-------------------
<IMSetPrivacyListRequest>
   <list [name="name"]> // use default list if no name specified
      [
         // Entries are evaluated by the server in increasing order (1 then 2 then 3 ...)
         //
         // EG, this will allow 'foo@bar.com' but block all others @bar.com:
         //   <item action="allow" order="1" addr="foo@bar.com"/>
         //   <item action="deny" order="2" addr="bar.com"/>
         //
         <item action="allow|deny" order="UNIQUE_POSITIVE_INTEGER" addr="address OR domain"/>
      ]*
   </list>
</IMSetPrivacyListRequest>

<IMSetPrivacyListResponse/>


IMGatewayList - gateways to external IM services
--------------
<IMGatewayListRequest/>


<IMGatewayListResponse>
  <service name="name" type="aim|msn|yahoo|icq" domain="type.mydomain.com">
[     <registration  name="remoteName" state="connectionState" [timeUntilNextConnect="msec_until_next_connect_attempt"/> ] ]
  </service>
</IMGatewayListResponse/>

connectedState is one of:
   bad_auth               -- auth is bad, will not try to reconnect
   intentionally_offline  -- user's local im presence is "offline" so not connected
   disabled               -- the user's account has been disabled, we will not try to reconnect
                               (this is probably b/c we detected the user logged into the service
                                directly from another location)
   online
   shutdown               -- shutting down
   start                  -- just created, will attempt first connect soon
   trying_to_connect      -- connection attempt in progress
NOT_IMPLEMENTED_YET:   booted_by_other_login  -- will not retry connect: someone has connected to our account has connected from another place

IMGatewayRegister 
-----------------
<IMGatewayRegister op="reg" service="SERVICE_NAME" name="remoteName" password="remotePassword"/>
<IMGatewayRegister op="unreg" service="SERVICE_NAME"/>
<IMGatewayRegister op="reconnect" service="SERVICE_NAME"/> // tell the service to try a reconnect right now, also re-enable if the service was in the disabled state

<IMGatewayRegisterResponse result="0|1"/>



============================================================
IM NOTIFICATIONS
============================================================

//
// In soap header block (see soap.txt):
//
  [<soap:Header>
     <context xmlns="urn:zimbra">
       ...
       <notify>
          [<deleted.../>]
          [<created.../>]
          [<modified.../>]
          [
             <im>
                [
                //  Asynchronous Roster Response                
                    <n type="roster">     
                       [<n type="subscribed"...>]* // see "subscribed" notification below
                       [<n type="unsubscribed"...>]* // see "unsubscribed" notification below
                       ...
                    </n>
                ]?

                'ask' means we are pending a response to our request to subscribe/unsubscribe
                 ---> EG:  (subscription="none" ask="subscribe") means we're waiting
                 for a response to subscribe, but we haven't received one yet
                [
                   <n type="subscribed" to="TOADDR" name="NAME" groups="GROUPS" [ask="subscribe|unsubscribe"]/> // you added them to your buddy list
                ]*
                [
                   <n type="unsubscribed" to="TOADDR" groups="GROUPS" [ask="subscribe|unsubscribe"]/> // you removed them from your buddy list
                ]*
                [
                // NEW MESSAGE RECEIVED:
                   <n type="message" from="address" thread="chat-id" ts="TIMESTAMP" [error="recipient_unavailable"]>
                      [<subject [lang="LANG"]>SUBJECT</subject>]
                      [<body [lang="LANG"]>BODY</body>]
                      [<typing/>]
                   </n>
                ]*
                [
                // Presence update for a specific user
                   <n type="presence" from="FROMADDR" [lang="en"] [show="away|chat|dnd|xa"] [priority="0-255"] [status="STATUS"]/>
                ]*
                [
                // User wants to add you to their buddy list (see <AuthorizeSubscribe> above)
                   <n type="subscribe" from="FROMADDR"/> 
                ]*
                [
                   <n type="enteredchat" thread="chat-id" addr="ADDRESS"/> // specified user entered the chat
                ]*
                [
                   <n type="leftchat" thread="chat-id" addr="ADDRESS"/> // specified user left the chat
                ]*
                [
                 // An invitation to join a group chat:
                   <n type="invited" thread="chat-id" addr="ADDRESS">INVITATION_MESSAGE</n>
                ]*
                [
                // interop gateway has succeeded/failed to connect us, see <IMGatewayListResponse> above for more info
                  <n type="gwStatus" service="GATEWAY_SERVICE_NAME" state="connectedState SEE ABOVE" [timeUntilNextConnect="msec_until_next_connect_attempt"/> ] />
                ]*
                [
                // your account has connected to the interop service from another location
                  <n type="otherLocation" service="GATEWAY_SERVICE_NAME" username="REMOTE_SERVICE_USERNAME"/>
                ]
                [
                // privacy (block/allow) list
                  <n type="privacy">
                     <list name="name">
                        [
                           <item action="deny" order="UNIQUE_POSITIVE_INTEGER" addr="address OR domain"/>
                        ]*
                     </list>
                  </n>   
                ]
             </im>]
          ]?     
        </notify>]

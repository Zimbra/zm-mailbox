=============================================
==
==
== Install Instructions for Intel Mac OS X
==
==
=============================================

The following instructions detail how to get a development
environment setup for Zimbra on an Intel Mac running OS X 10.5.


PREREQUISITE SOFWARE
====================

   * Perforce - the P4 Command-Line Client ("P4") and P4 Visual Client ("P4V")
		Use the latest version
		http://www.perforce.com/perforce/downloads/index.html

   * MySQL - you MUST install the x86 version
		Use version 5 (or higher)
		http://dev.mysql.com/downloads/mysql/5.0.html#macosx-dmg

OVERVIEW
========

--  Setup the P4 Command-Line Client
--  Configure Build Environment
--  Download Zimbra Source
--  Install MySQL
--  Configure OpenLDAP
--  Update Java Certs Password
--  Build and Deploy Zimbra Server
--  Starting and Stopping Servers
--  Configure JDK for Zimbra Command Line Tools
--  Install Mail Transfer Agent


SETUP THE P4 COMMAND-LINE CLIENT
================================

1. Download P4 executable Command-Line Client

2. Move p4 binary to /usr/local/bin

3. Make p4 executable:

	chmod +x

More information on configuring the P4 client is available at:
http://www.perforce.com/perforce/doc.current/manuals/p4guide/01_install.html#1070774


CONFIGURE BUILD ENVIRONMENT
===========================

1. Edit the shell configuration file:

	vi ~/.bash_profile

2. Configure the P4 client environment variables

	# p4 client setup
	export P4USER={user-name}
	export P4PORT=depot.lab.zimbra.com:1666
	export P4CLIENT={workspace}

3. Set Zimbra source directory:

	# set SRCDIR to P4 sync directory
	export SRCDIR=~/p4/main

4. Set PATH to include Zimbra command line tools:

	PATH=$PATH:/opt/zimbra/bin
	export PATH

5. Reload the shell configuration file:

	source ~/.bash_profile
		
6. Create the zimbra output directory

	mkdir -p /opt/zimbra


DOWNLOAD ZIMBRA SOURCE
======================

1. Using the P4 Visual Client, setup a Connection to access the Zimbra depot.

	Note: The Public Zimbra source code P4 depot is available at [Server=codes.zimbra.com, Port=2666, User=public, Password=public1234]

2. Configure your Workspace to include the following in the View:
		
	For the basic server only include:
		//depot/main/ZimbraCommon/... //{workspace-name}/ZimbraCommon/...
		//depot/main/ZimbraIM/... //{workspace-name}/ZimbraIM/...
		//depot/main/ZimbraServer/... //{workspace-name}/ZimbraServer/...
		//depot/main/ThirdParty/jetty/... //{workspace-name}/ThirdParty/jetty/...

	For the webclient also include
		//depot/main/Ajax/... //{workspace-name}/Ajax/...
		//depot/main/ZimbraWebClient/... //{workspace-name}/ZimbraWebClient/...
		//depot/main/ZimbraTagLib/... //{workspace-name}/ZimbraTagLib/...
		//depot/main/Zimlet/... //{workspace-name}/Zimlet/...

	If you are using IDEA Intellij include
		//depot/main/Zimbra.ipr //{workspace-name}/Zimbra.ipr

2. After you setup Perforce, login and sync the client. This will get the files needed for the rest of the build & install.


INSTALL MySQL
=============

1. Download MySQL disk image (mysql-5.1.46-osx10.5-x86_64.dmg)

	* NOTE: This is the version for Mac OS X Leopard (10.5.x). Select the
	        appropriate image for Snow Leopard (10.6.x) as needed. Depending
	        on your machine, you may want the 32-bit version.

2. Install both packages included in the distribution:

	PACKAGE #1: mysql-5.1.46-osx10.5-x86_64.pkg
		The MySQL binaries install package

	PACKAGE #2: MySQLStartupItem.pkg
		Configures MySQL to automatically start during system startup. Sets MySQL in /Library/StartupItems/MySQLCOM

	* NOTE: The MySQL image also comes with a preferences panel called
	        MySQL.prefPane. To make this preference available for only
	        your user or all user, run one of the following commands:

	# make available only for *your* user
	cp MySQL.prefPane ~/Library/PreferencePanes/

	# make available for *all* users
	sudo cp MySQL.prefPane /Library/PreferencePanes/

3. Create a symbolic link from the zimbra install directory to the mysql install. Run the following command:

	sudo ln -s /usr/local/mysql /opt/zimbra/mysql

4. Create the mysql configuration file.

	sudo vi /opt/zimbra/mysql/data/my.cnf

	[mysqld]
	bind-address = localhost
	port = 7306

5. Start MySQL with the following command:

	sudo -b /opt/zimbra/mysql/bin/mysqld_safe --user=mysql

	Note: With MySQLStartupItem package installed, mysqld will start automatically on reboot.

6. Set the database "root" password to the ant expected "zimbra":

	/opt/zimbra/mysql/bin/mysqladmin -u root password zimbra

7. Confirm mysql server processes are running:

	bash-3.2# ps -a

	PID TTY           TIME CMD
	14464 ttys000    0:00.02 login -pf testuser
	14465 ttys000    0:00.01 -bash
	14476 ttys000    0:00.01 su - testuser
	14477 ttys000    0:00.10 -bash
	14596 ttys000    0:00.04 /bin/bash
	14652 ttys000    0:00.01 /bin/sh /opt/zimbra/mysql/bin/safe_mysqld --user=mysql
	14668 ttys000    0:00.05 /usr/local/mysql/bin/mysqld --basedir=/usr/local/mysql
	14669 ttys000    0:00.00 ps -a

8. The MySQL Server log file can be found at:

	/opt/zimbra/mysql/data/{server-name}.err

9. To stop MySQL server:

	/opt/zimbra/mysql/bin/mysqladmin -u root -p shutdown


CONFIGURE OPENLDAP
==================

1. OpenLDAP is installed automatically during "reset-all". The only manual change needed is to allow the local user to start LDAP without password.

2. Run "sudo visudo" and add the following at the end of the file (i.e. in the "User privledge section"):

	{user-name} ALL=NOPASSWD:/opt/zimbra/libexec/zmslapd

	Note: replace {user-name} with your local user name and be sure to insert a [TAB] between the {user-name} and the word "ALL"

UPDATE JAVA CERTS PASSWORD
==========================

If you have a Java version greater than or equal to 1.5.0_20 on your Mac, 
you need to modify the certificates password. To check your version of Java,
type the following command:

	java -version

If you need to update your certificates password, execute the following
command:

	keytool -keystore /System/Library/Frameworks/JavaVM.framework/Versions/A/Resources/Deploy.bundle/Contents/Home/lib/security/cacerts \
		-storepasswd -new changeit -storepass changeme


BUILD AND DEPLOY ZIMBRA SERVER
==============================

1. Change to the Zimbra server source directory:

	cd $SRCDIR/ZimbraServer

2. Run the "reset all" ant task:

	ant reset-all

3. Browse to your local server and login as "Demo User One":

	http://localhost:7070/zimbra

	Username: user1
	Password: test123

4. Browse to your local server admin console and login as "Admin":

	https://localhost:7071/zimbraAdmin

	Username: admin
	Password: test123


STARTING AND STOPPING SERVERS
=============================

1. To stop all servers (webserver/jetty, LDAP):

	cd $SRCDIR/ZimbraServer
	ant stop-servers

2. To start or stop LDAP:

	cd $SRCDIR/ZimbraServer
	ant [start-ldap | stop-ldap]

3. To start or stop webserver/jetty:

	cd $SRCDIR/ZimbraServer
	ant [start-webserver | stop-webserver]


CONFIGURE JDK FOR ZIMBRA COMMAND LINE TOOLS
===========================================

Command-line tools like zmprov, zmmailbox, zmsoap, etc., depend
on the JDK to be in /opt/zimbra/java.  Either download the JDK
and extract there, or create a symbolic link to your existing
JDK location.

1. Browse to the zimbra directory:

	cd /opt/zimbra

2. Create symbolic link to an existing JDK. The following shows linking
   to JDK 1.6 on Mac: 

	sudo ln -s /System/Library/Frameworks/JavaVM.framework/Versions/1.6/Home/ java

INSTALL MAIL TRANSFER AGENT
===========================

In order to send mail to/from users in the Zimbra product
you will need a mail transfer agent. However, you do not need
a full MTA such as Postfix in order for this to work. Instead,
you can install a Perl script that acts as a simple MTA.

NOTE: In order to continue with this step, you need to have
installed the Mac OS X development tools. If you haven't done
this yet, insert disc 1 and install Xcode Tools/XcodeTools.mpkg

First, you need to install some Perl packages by running
the following commands: [The first time you run CPAN, you
will need to configure it -- use default settings where
possible]

sudo -H -s
cpan

At the CPAN prompt, type the following commands:

install Net::SMTP::Server
install Net::LMTP
install Net::DNS
quit

If you're use Mac OS 10.5 or later, run "sudo visudo"
and add the following line to the Defaults section:

Defaults        env_keep += "ZIMBRA_HOSTNAME"

to allow ZIMBRA_HOSTNAME to be exported into a sudo
environment.  Now you can run the Perl MTA with the following
commands:

export ZIMBRA_HOSTNAME=`/opt/zimbra/bin/zmhostname`
sudo -b perl $SRCDIR/ZimbraServer/src/perl/zMTAHack.pl

NOTE: When sending mail, you need to fully qualify the
address as {username}@$ZIMBRA_HOSTNAME. The {username} is
"user1" through "user5".
